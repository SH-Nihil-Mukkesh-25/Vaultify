<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Vaultify Security Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 min-h-screen p-6">
  <div class="max-w-7xl mx-auto">
    <div class="mb-8">
      <h1 class="text-4xl font-bold text-white mb-2">üîê Vaultify Security Dashboard</h1>
      <p class="text-slate-400">Real-time security monitoring system</p>
    </div>

    <div id="stats" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6"></div>

    <div class="flex flex-wrap gap-3 mb-6">
      <select id="eventFilter" class="px-4 py-2 bg-slate-700 text-white border border-slate-600 rounded-lg">
        <option value="all">All Events</option>
        <option value="motion_alert">Motion Alerts</option>
        <option value="door">Door Operations</option>
        <option value="rfid">RFID Events</option>
      </select>
      <select id="limitFilter" class="px-4 py-2 bg-slate-700 text-white border border-slate-600 rounded-lg">
        <option value="10">Last 10</option>
        <option value="25">Last 25</option>
        <option value="50">Last 50</option>
      </select>
      <button id="refreshBtn" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg">üîÑ Refresh</button>
      <button id="autoRefreshBtn" class="px-4 py-2 bg-slate-700 text-white rounded-lg">Auto Refresh: OFF</button>
    </div>

    <div id="connectionStatus" class="mb-6 p-4 bg-slate-800 border border-slate-700 rounded-lg">
      <div class="flex items-center gap-2">
        <div id="statusDot" class="w-3 h-3 rounded-full bg-yellow-500 animate-pulse"></div>
        <span id="statusText" class="text-white">Connecting...</span>
      </div>
    </div>

    <div class="bg-slate-800 border border-slate-700 rounded-lg p-6 mb-6">
      <h2 class="text-2xl font-semibold text-white mb-4">üìã Event Logs</h2>
      <div id="logs" class="space-y-2 max-h-96 overflow-y-auto">
        <p class="text-slate-400 text-center py-8">Loading logs...</p>
      </div>
    </div>

    <div class="bg-slate-800 border border-slate-700 rounded-lg p-6 mb-6">
      <h2 class="text-2xl font-semibold text-white mb-4">ü§ñ AI Security Insights</h2>
      <div id="aiSummary" class="text-slate-300 p-4 bg-slate-900 rounded-lg border border-slate-700">Loading...</div>
    </div>

    <div class="bg-slate-800 border border-slate-700 rounded-lg p-6 mb-6">
      <h2 class="text-2xl font-semibold text-white mb-4">üí¨ Ask Security AI</h2>
      <div class="flex gap-3 mb-4">
        <input id="questionInput" type="text" placeholder="Ask about security events..." class="flex-1 px-4 py-3 bg-slate-900 text-white border border-slate-700 rounded-lg" onkeypress="if(event.key==='Enter') askQuestion()" />
        <button id="askBtn" class="px-6 py-3 bg-green-600 hover:bg-green-700 text-white rounded-lg">Ask AI</button>
      </div>
      <div id="aiAnswer" class="text-slate-300 p-4 bg-slate-900 rounded-lg border border-slate-700">
        <p class="text-slate-500 italic">Ask me anything about your security system...</p>
      </div>
    </div>
  </div>

  <script>
    const BACKEND_URL = "https://vaultify-6rbk.onrender.com";
    
    const logList = document.getElementById("logs");
    const statsDiv = document.getElementById("stats");
    const statusDot = document.getElementById("statusDot");
    const statusText = document.getElementById("statusText");
    const aiSummary = document.getElementById("aiSummary");
    const aiAnswer = document.getElementById("aiAnswer");
    const questionInput = document.getElementById("questionInput");

    const eventConfig = {
      motion_alert: { icon: "üö®", color: "bg-red-900 border-red-700 text-red-200" },
      door_unlocked: { icon: "üîì", color: "bg-blue-900 border-blue-700 text-blue-200" },
      door_locked: { icon: "üîí", color: "bg-purple-900 border-purple-700 text-purple-200" },
      rfid_invalid: { icon: "‚ùå", color: "bg-red-900 border-red-700 text-red-200" },
      default: { icon: "üìù", color: "bg-slate-700 border-slate-600 text-slate-200" }
    };

    function updateStatus(connected) {
      statusDot.className = connected ? "w-3 h-3 rounded-full bg-green-500" : "w-3 h-3 rounded-full bg-red-500 animate-pulse";
      statusText.textContent = connected ? "Connected" : "Connection error";
    }

    async function fetchLogs() {
      try {
        const type = eventFilter.value;
        const limit = limitFilter.value;
        const url = type === "all" ? `${BACKEND_URL}/logs?limit=${limit}` : `${BACKEND_URL}/logs?limit=${limit}&type=${type}`;
        const res = await fetch(url);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        updateStatus(true);
        
        if (!data || data.length === 0) {
          logList.innerHTML = '<p class="text-slate-400 text-center py-8">No logs available</p>';
          return;
        }

        logList.innerHTML = data.map(log => {
          const config = eventConfig[log.event_type] || eventConfig.default;
          const time = new Date(log.timestamp).toLocaleString();
          return `
            <div class="p-4 ${config.color} border rounded-lg">
              <div class="flex items-start gap-3">
                <span class="text-2xl">${config.icon}</span>
                <div class="flex-1">
                  <div class="flex justify-between mb-1">
                    <span class="font-semibold">${log.event_type.toUpperCase()}</span>
                    <span class="text-xs opacity-75">${time}</span>
                  </div>
                  <p class="text-sm">${log.message || log.detail}</p>
                </div>
              </div>
            </div>
          `;
        }).join("");
      } catch (err) {
        console.error(err);
        updateStatus(false);
        logList.innerHTML = '<p class="text-red-400 text-center py-8">Failed to load logs</p>';
      }
    }

    async function fetchStats() {
      try {
        const res = await fetch(`${BACKEND_URL}/stats`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const stats = await res.json();
        statsDiv.innerHTML = `
          <div class="p-6 bg-slate-800 border border-slate-700 rounded-lg text-center">
            <p class="text-slate-400 text-sm mb-2">Total Events</p>
            <p class="text-4xl font-bold text-white">${stats.total_logs || 0}</p>
          </div>
          <div class="p-6 bg-slate-800 border border-slate-700 rounded-lg text-center">
            <p class="text-slate-400 text-sm mb-2">Event Types</p>
            <p class="text-4xl font-bold text-blue-400">${Object.keys(stats.event_types || {}).length}</p>
          </div>
          <div class="p-6 bg-slate-800 border border-slate-700 rounded-lg text-center">
            <p class="text-slate-400 text-sm mb-2">Alerts</p>
            <p class="text-4xl font-bold text-red-400">${stats.alerts || 0}</p>
          </div>
          <div class="p-6 bg-slate-800 border border-slate-700 rounded-lg text-center">
            <p class="text-slate-400 text-sm mb-2">Door Ops</p>
            <p class="text-4xl font-bold text-green-400">${stats.door_operations || 0}</p>
          </div>
        `;
      } catch (err) {
        console.error(err);
      }
    }

    async function fetchSummary() {
      try {
        const res = await fetch(`${BACKEND_URL}/summary`);
        if (!res.ok) throw new Error();
        const data = await res.json();
        aiSummary.textContent = data.summary || "No summary available";
      } catch (err) {
        aiSummary.textContent = "AI summary unavailable";
      }
    }

    async function askQuestion() {
      const q = questionInput.value.trim();
      if (!q) return;
      aiAnswer.innerHTML = '<p class="text-blue-400">AI thinking...</p>';
      try {
        const res = await fetch(`${BACKEND_URL}/ask`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ question: q })
        });
        const data = await res.json();
        aiAnswer.innerHTML = `<p>${data.answer || "No answer available"}</p>`;
        questionInput.value = "";
      } catch (err) {
        aiAnswer.innerHTML = '<p class="text-red-400">Error getting AI response</p>';
      }
    }

    document.getElementById("refreshBtn").addEventListener("click", () => { fetchLogs(); fetchStats(); fetchSummary(); });
    document.getElementById("askBtn").addEventListener("click", askQuestion);
    document.getElementById("eventFilter").addEventListener("change", fetchLogs);
    document.getElementById("limitFilter").addEventListener("change", fetchLogs);

    let autoRefresh = false;
    document.getElementById("autoRefreshBtn").addEventListener("click", function() {
      autoRefresh = !autoRefresh;
      this.textContent = `Auto Refresh: ${autoRefresh ? "ON" : "OFF"}`;
      this.className = autoRefresh ? "px-4 py-2 bg-green-600 text-white rounded-lg" : "px-4 py-2 bg-slate-700 text-white rounded-lg";
      if (autoRefresh) setInterval(() => { fetchLogs(); fetchStats(); fetchSummary(); }, 5000);
    });

    fetchLogs();
    fetchStats();
    fetchSummary();
  </script>
</body>
</html>

<!-- <!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Vaultify Security Dashboard</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #f5f5f5;
      color: #333;
    }
    h1 { color: #222; }
    h2, h3 { margin-top: 20px; }
    #logs { max-height: 300px; overflow-y: auto; background: #fff; border: 1px solid #ccc; padding: 10px; }
    .log { padding: 5px; border-bottom: 1px solid #eee; }
    .motion_alert { color: red; font-weight: bold; }
    .door_unlocked { color: green; font-weight: bold; }
    .door_autolock { color: orange; font-weight: bold; }
    .rfid_invalid { color: darkred; font-weight: bold; }
    #ai-summary, #ai-answer { background: #fff; padding: 10px; border: 1px solid #ccc; min-height: 40px; }
    input { padding: 5px; width: 250px; }
    button { padding: 6px 10px; margin-left: 5px; cursor: pointer; }
  </style>
</head>
<body>
  <h1>Vaultify Security Dashboard</h1>
  <h2 id="door-status">üîí Door Status Unknown</h2>

  <h3>Event Logs</h3>
  <div id="logs">Loading logs...</div>

  <h3>AI Summary</h3>
  <div id="ai-summary">Loading summary...</div>

  <h3>Ask AI</h3>
  <input type="text" id="ai-question" placeholder="Ask about security events"/>
  <button onclick="askAI()">Ask AI</button>
  <div id="ai-answer">No answer yet.</div>

  <script>
    const BACKEND_URL = "https://vaultify-6rbk.onrender.com";
    const logsDiv = document.getElementById("logs");
    const summaryDiv = document.getElementById("ai-summary");
    const doorStatusDiv = document.getElementById("door-status");
    const aiAnswerDiv = document.getElementById("ai-answer");

    async function fetchLogs() {
      try {
        const res = await fetch(`${BACKEND_URL}/logs`);
        const data = await res.json();
        
        if (!data || data.length === 0) {
          logsDiv.innerHTML = "No logs available yet.";
          doorStatusDiv.innerText = "üîí Door Status Unknown";
          return;
        }

        // Display logs
        logsDiv.innerHTML = data.slice().reverse().map(log => {
          let cls = log.event_type ? log.event_type.replace(/\s+/g, "_") : "default";
          return `<div class="log ${cls}"><strong>${log.event_type || 'EVENT'}</strong>: ${log.message || log.detail || 'No details'}</div>`;
        }).join("");

        // Update door status
        const lastDoorEvent = data.slice().reverse().find(e => 
          e.event_type && e.event_type.includes("door")
        );
        doorStatusDiv.innerText = lastDoorEvent ? `üîë ${lastDoorEvent.message}` : "üîí Door Status Unknown";

      } catch (err) {
        console.error(err);
        logsDiv.innerHTML = "Error fetching logs.";
      }
    }

    async function fetchSummary() {
      try {
        const res = await fetch(`${BACKEND_URL}/summary`);
        const data = await res.json();
        summaryDiv.innerText = data.summary || "No summary available yet.";
      } catch (err) {
        console.error(err);
        summaryDiv.innerText = "Error fetching summary.";
      }
    }

    async function askAI() {
      const question = document.getElementById("ai-question").value;
      if (!question) return;
      try {
        const res = await fetch(`${BACKEND_URL}/ask`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ question: question })
        });
        const data = await res.json();
        aiAnswerDiv.innerText = data.answer || "No answer yet.";
      } catch (err) {
        console.error(err);
        aiAnswerDiv.innerText = "Error getting AI response.";
      }
    }

    // Auto-refresh logs every 5s, summary every 10s
    setInterval(fetchLogs, 5000);
    setInterval(fetchSummary, 10000);

    // Initial fetch
    fetchLogs();
    fetchSummary();
  </script>
</body>
</html> -->