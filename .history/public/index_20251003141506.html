<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-Content-Type-Options" content="nosniff">
  <title>Vaultify Security Dashboard</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      color: #333;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    h1 {
      color: white;
      text-align: center;
      font-size: 2.5em;
      margin-bottom: 30px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .card {
      background: white;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      transition: transform 0.2s;
    }

    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 12px rgba(0,0,0,0.15);
    }

    .card h2 {
      font-size: 1.3em;
      margin-bottom: 15px;
      color: #667eea;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .door-status {
      text-align: center;
      padding: 30px;
      font-size: 1.8em;
      font-weight: bold;
    }

    .status-icon {
      font-size: 3em;
      margin-bottom: 10px;
    }

    .status-locked { color: #e74c3c; }
    .status-unlocked { color: #27ae60; }
    .status-alarm { color: #e67e22; animation: pulse 1s infinite; }
    .status-unknown { color: #95a5a6; }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    #logs {
      max-height: 400px;
      overflow-y: auto;
      background: #f8f9fa;
      border-radius: 8px;
      padding: 15px;
    }

    .log {
      padding: 12px;
      margin-bottom: 8px;
      border-left: 4px solid #667eea;
      background: white;
      border-radius: 4px;
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .log-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .log-event {
      font-weight: bold;
      text-transform: capitalize;
    }

    .log-timestamp {
      font-size: 0.85em;
      color: #666;
    }

    .log-detail {
      color: #555;
      font-size: 0.9em;
    }

    .log.motion_alert { border-left-color: #e74c3c; }
    .log.door_unlocked { border-left-color: #27ae60; }
    .log.door_locked { border-left-color: #3498db; }
    .log.door_autolock { border-left-color: #f39c12; }
    .log.rfid_invalid { border-left-color: #c0392b; }
    .log.rfid_valid { border-left-color: #16a085; }

    .log.motion_alert .log-event { color: #e74c3c; }
    .log.door_unlocked .log-event { color: #27ae60; }
    .log.door_locked .log-event { color: #3498db; }
    .log.door_autolock .log-event { color: #f39c12; }
    .log.rfid_invalid .log-event { color: #c0392b; }
    .log.rfid_valid .log-event { color: #16a085; }

    #ai-summary {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      min-height: 80px;
      line-height: 1.6;
      white-space: pre-wrap;
    }

    .ai-input-group {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }

    input[type="text"] {
      flex: 1;
      padding: 12px 15px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 1em;
      transition: border-color 0.3s;
    }

    input[type="text"]:focus {
      outline: none;
      border-color: #667eea;
    }

    button {
      padding: 12px 24px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 1em;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.3s;
    }

    button:hover {
      background: #5568d3;
    }

    button:active {
      transform: scale(0.98);
    }

    #ai-answer {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      min-height: 60px;
      line-height: 1.6;
      white-space: pre-wrap;
    }

    .loading {
      color: #999;
      font-style: italic;
    }

    .error {
      color: #e74c3c;
      background: #fadbd8;
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 10px;
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }

    .stat-item {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
    }

    .stat-value {
      font-size: 2em;
      font-weight: bold;
      color: #667eea;
    }

    .stat-label {
      font-size: 0.85em;
      color: #666;
      margin-top: 5px;
    }

    .refresh-indicator {
      text-align: center;
      color: white;
      font-size: 0.9em;
      margin-top: 20px;
      opacity: 0.8;
    }

    @media (max-width: 768px) {
      h1 { font-size: 1.8em; }
      .dashboard-grid { grid-template-columns: 1fr; }
      .ai-input-group { flex-direction: column; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîê Vaultify Security Dashboard</h1>
    
    <div class="dashboard-grid">
      <div class="card">
        <div class="door-status" id="door-status">
          <div class="status-icon">üîí</div>
          <div>Door Status Unknown</div>
        </div>
        <div class="stats">
          <div class="stat-item">
            <div class="stat-value" id="total-events">0</div>
            <div class="stat-label">Total Events</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="alerts-count">0</div>
            <div class="stat-label">Alerts</div>
          </div>
        </div>
      </div>

      <div class="card" style="grid-column: span 2;">
        <h2>üìã Event Logs</h2>
        <div id="logs" class="loading">Loading logs...</div>
      </div>
    </div>

    <div class="dashboard-grid">
      <div class="card" style="grid-column: span 2;">
        <h2>ü§ñ AI Security Summary</h2>
        <div id="ai-summary" class="loading">Loading summary...</div>
      </div>
    </div>

    <div class="dashboard-grid">
      <div class="card" style="grid-column: span 2;">
        <h2>üí¨ Ask AI About Security Events</h2>
        <div class="ai-input-group">
          <input type="text" id="ai-question" placeholder="e.g., How many times was the door unlocked today?" />
          <button onclick="askAI()">Ask AI</button>
        </div>
        <div id="ai-answer">No answer yet. Ask a question above!</div>
      </div>
    </div>

    <div class="refresh-indicator">
      Last updated: <span id="last-update">Never</span> | Auto-refresh: Every 5 seconds
    </div>
  </div>

  <script>
    const BACKEND_URL = "https://vaultify-6rbk.onrender.com";
    const logsDiv = document.getElementById("logs");
    const summaryDiv = document.getElementById("ai-summary");
    const doorStatusDiv = document.getElementById("door-status");
    const aiAnswerDiv = document.getElementById("ai-answer");
    const totalEventsEl = document.getElementById("total-events");
    const alertsCountEl = document.getElementById("alerts-count");
    const lastUpdateEl = document.getElementById("last-update");

    function updateLastUpdate() {
      const now = new Date();
      lastUpdateEl.textContent = now.toLocaleTimeString();
    }

    function formatTimestamp(timestamp) {
      if (!timestamp) return 'Unknown time';
      try {
        const date = new Date(timestamp);
        return date.toLocaleString();
      } catch (e) {
        return timestamp;
      }
    }

    function updateDoorStatus(logs) {
      if (!logs || logs.length === 0) {
        doorStatusDiv.innerHTML = `
          <div class="status-icon status-unknown">‚ùì</div>
          <div>Door Status Unknown</div>
        `;
        return;
      }

      const relevantEvents = logs.filter(e => 
        e.event.includes('door') || e.event.includes('motion_alert')
      );
      
      if (relevantEvents.length === 0) {
        doorStatusDiv.innerHTML = `
          <div class="status-icon status-locked">üîí</div>
          <div>Door Locked</div>
        `;
        return;
      }

      const lastEvent = relevantEvents[0];
      
      if (lastEvent.event === 'motion_alert') {
        doorStatusDiv.innerHTML = `
          <div class="status-icon status-alarm">üö®</div>
          <div>THEFT ALERT ACTIVE</div>
        `;
      } else if (lastEvent.event === 'door_unlocked') {
        doorStatusDiv.innerHTML = `
          <div class="status-icon status-unlocked">üîì</div>
          <div>Door Unlocked</div>
        `;
      } else {
        doorStatusDiv.innerHTML = `
          <div class="status-icon status-locked">üîí</div>
          <div>Door Locked</div>
        `;
      }
    }

    function updateStats(logs) {
      if (!logs) return;
      
      totalEventsEl.textContent = logs.length;
      
      const alertCount = logs.filter(log => 
        log.event === 'motion_alert' || log.event === 'rfid_invalid'
      ).length;
      alertsCountEl.textContent = alertCount;
    }

    async function fetchLogs() {
      try {
        const res = await fetch(${BACKEND_URL}/api/logs);
        
        if (!res.ok) {
          throw new Error(HTTP ${res.status}: ${res.statusText});
        }
        
        const data = await res.json();
        
        if (!data.logs || data.logs.length === 0) {
          logsDiv.innerHTML = `<div style="text-align: center; padding: 20px; color: #999;">
            No logs available yet. Waiting for events from ESP32...
          </div>`;
          updateDoorStatus(null);
          return;
        }

        const sortedLogs = data.logs.slice().reverse();
        
        logsDiv.innerHTML = sortedLogs.map(log => {
          const eventClass = log.event.replace(/\s+/g, "_");
          const eventName = log.event.replace(/_/g, ' ');
          const timestamp = formatTimestamp(log.timestamp);
          
          return `
            <div class="log ${eventClass}">
              <div class="log-header">
                <span class="log-event">${eventName}</span>
                <span class="log-timestamp">${timestamp}</span>
              </div>
              <div class="log-detail">${log.detail}</div>
            </div>
          `;
        }).join("");

        updateDoorStatus(sortedLogs);
        updateStats(data.logs);
        updateLastUpdate();

      } catch (err) {
        console.error('Error fetching logs:', err);
        logsDiv.innerHTML = `<div class="error">
          ‚ö† Error connecting to backend: ${err.message}<br>
          Make sure the backend is running at ${BACKEND_URL}
        </div>`;
      }
    }

    async function fetchSummary() {
      try {
        const res = await fetch(${BACKEND_URL}/api/summary);
        
        if (!res.ok) {
          throw new Error(HTTP ${res.status});
        }
        
        const data = await res.json();
        summaryDiv.textContent = data.summary || "No summary available yet.";
        summaryDiv.classList.remove('loading');
        
      } catch (err) {
        console.error('Error fetching summary:', err);
        summaryDiv.innerHTML = <div class="error">Error fetching summary: ${err.message}</div>;
      }
    }

    async function askAI() {
      const question = document.getElementById("ai-question").value.trim();
      
      if (!question) {
        aiAnswerDiv.innerHTML = <div style="color: #e67e22;">Please enter a question first.</div>;
        return;
      }
      
      aiAnswerDiv.innerHTML = <div class="loading">ü§î Thinking...</div>;
      
      try {
        const res = await fetch(${BACKEND_URL}/api/ask?question=${encodeURIComponent(question)});
        
        if (!res.ok) {
          throw new Error(HTTP ${res.status});
        }
        
        const data = await res.json();
        aiAnswerDiv.textContent = data.answer || "No answer available.";
        
      } catch (err) {
        console.error('Error asking AI:', err);
        aiAnswerDiv.innerHTML = <div class="error">Error: ${err.message}</div>;
      }
    }

    document.getElementById("ai-question").addEventListener("keypress", function(e) {
      if (e.key === "Enter") {
        askAI();
      }
    });

    setInterval(fetchLogs, 5000);
    setInterval(fetchSummary, 10000);

    fetchLogs();
    fetchSummary();
  </script>
</body>
</html>